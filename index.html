<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Callanix â€” KVS Aliganj II Shift</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="description" content="Callanix: AI Assistant for KVS Aliganj II Shift" />
  
  <!-- Include the config file -->
  <script src="config.js"></script>
  
  <style>
    /* Your existing CSS styles remain exactly the same */
    :root {
      --bg: #f5f7fb;
      --panel: #ffffff;
      --text: #2d3748;
      --muted: #4a5568;
      --brand1: #667eea;
      --brand2: #764ba2;
      --border: #e2e8f0;
      --shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
    }
    html, body {
            margin: 0; 
            padding: 0;
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .app {
            display: flex; 
            flex-direction: column; 
            min-height: 100vh;
        }
        
        .app-header {
            background: linear-gradient(135deg, var(--brand1), var(--brand2));
            color: #fff; 
            padding: 16px 24px;
            box-shadow: var(--shadow);
            position: sticky; 
            top: 0; 
            z-index: 10;
        }
        
        .brand { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }
        
        .brand-logo { 
            width: 42px; 
            height: 42px; 
            border-radius: 10px; 
            background: rgba(255,255,255,0.15); 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 800; 
            font-size: 20px; 
            border: 2px solid rgba(255,255,255,0.25); 
        }
        
        .brand h1 { 
            font-size: 20px; 
            margin: 0; 
            font-weight: 700; 
        }
        
        .brand small { 
            display: block; 
            opacity: 0.9; 
            font-weight: 500; 
            font-size: 13px; 
        }
        
        .header-stats { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 12px; 
            margin-top: 12px; 
        }
        
        .pill { 
            background: rgba(255,255,255,0.18); 
            border: 1px solid rgba(255,255,255,0.25); 
            padding: 6px 12px; 
            border-radius: 999px; 
            font-size: 12px; 
            font-weight: 600; 
        }
        
        .pill.danger { 
            background: rgba(239,68,68,0.35); 
            border-color: rgba(239,68,68,0.55); 
        }
        
        .app-main { 
            flex: 1 1 auto; 
            max-width: 900px; 
            margin: 16px auto; 
            width: 95%; 
            display: grid; 
            grid-template-rows: 1fr auto; 
            gap: 12px; 
        }
        
        .chat-panel { 
            background: var(--panel); 
            border: 1px solid var(--border); 
            border-radius: 14px; 
            box-shadow: var(--shadow); 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            min-height: 65vh; 
        }
        
        .messages { 
            flex: 1 1 auto; 
            overflow-y: auto; 
            padding: 24px; 
            scroll-behavior: smooth; 
        }
        
        .msg { 
            display: flex; 
            gap: 12px; 
            margin-bottom: 20px; 
        }
        
        .msg .bubble { 
            padding: 12px 16px; 
            border-radius: 14px; 
            max-width: 100%; 
            width: fit-content; 
            border: 1px solid var(--border); 
            box-shadow: 0 2px 10px rgba(0,0,0,0.04); 
        }
        
        .msg.user { 
            justify-content: flex-end; 
        }
        
        .msg.user .bubble { 
            background: linear-gradient(135deg, #eef2ff, #f0eaff); 
            border-color: #d6d9ff; 
        }
        
        .msg.ai .bubble { 
            background: #fff; 
            border-color: var(--border); 
        }
        
        .meta { 
            font-size: 12px; 
            color: var(--muted); 
            margin-bottom: 8px; 
        }
        
        .meta .model-name { 
            font-weight: 600; 
        }
        
        .composer { 
            display: grid; 
            grid-template-columns: 1fr auto; 
            gap: 10px; 
            align-items: center; 
            padding: 10px; 
            background: var(--panel); 
            border: 1px solid var(--border); 
            border-radius: 14px; 
            box-shadow: var(--shadow); 
        }
        
        .composer input[type="text"] { 
            width: 100%; 
            padding: 14px; 
            border-radius: 10px; 
            border: 1px solid var(--border); 
            outline: none; 
            font-size: 16px; 
        }
        
        .composer button { 
            padding: 12px 18px; 
            border: none; 
            border-radius: 10px; 
            background: linear-gradient(135deg, var(--brand1), var(--brand2)); 
            color: #fff; 
            font-weight: 700; 
            cursor: pointer; 
            transition: transform 0.1s ease; 
        }
        
        .composer button:hover { 
            transform: scale(1.05); 
        }
        
        .composer button:disabled { 
            opacity: 0.6; 
            cursor: not-allowed; 
            transform: none; 
        }
        
        .typing { 
            display: none; 
            align-items: center; 
            gap: 10px; 
            padding: 10px 24px; 
            color: var(--muted); 
        }
        
        .typing .dot { 
            width: 8px; 
            height: 8px; 
            border-radius: 50%; 
            background: var(--brand1); 
            animation: blink 1.4s infinite ease-in-out; 
        }
        
        .typing .dot:nth-child(2) { 
            animation-delay: 0.2s; 
        }
        
        .typing .dot:nth-child(3) { 
            animation-delay: 0.4s; 
        }
        
        @keyframes blink { 
            0%, 80%, 100% { 
                opacity: 0.2; 
            } 
            40% { 
                opacity: 1; 
            } 
        }
        
        .blocked-overlay { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.55); 
            display: none; 
            align-items: center; 
            justify-content: center; 
            z-index: 1000; 
        }
        
        .blocked-card { 
            background: #fff; 
            padding: 32px; 
            border-radius: 14px; 
            max-width: 540px; 
            width: 92%; 
            border: 1px solid var(--border); 
            box-shadow: var(--shadow); 
            text-align: center; 
        }
        
        /* === COMPLETE TEXT FORMATTING OVERHAUL (v5 - Human-Readable) === */
        .message-content {
            line-height: 1.8;
            font-size: 17px;
            word-wrap: break-word;
        }
        
        .message-content > *:first-child { 
            margin-top: 0; 
        }
        
        .message-content > *:last-child { 
            margin-bottom: 0; 
        }
        
        .message-content h1, .message-content h2, .message-content h3, .message-content h4, .message-content h5, .message-content h6 { 
            font-weight: 700; 
            color: #1a202c; 
            line-height: 1.4; 
            margin-top: 28px; 
            margin-bottom: 16px; 
        }
        
        .message-content h1 { 
            font-size: 30px; 
            border-bottom: 3px solid var(--brand1); 
            padding-bottom: 12px; 
        }
        
        .message-content h2 { 
            font-size: 24px; 
            border-bottom: 2px solid var(--brand2); 
            padding-bottom: 10px; 
        }
        
        .message-content h3 { 
            font-size: 20px; 
        }
        
        .message-content h4 { 
            font-size: 18px; 
            color: var(--brand1); 
        }
        
        .message-content h5 { 
            font-size: 17px; 
            font-weight: 600; 
        }
        
        .message-content h6 { 
            font-size: 17px; 
            font-style: italic; 
            color: var(--muted); 
        }
        
        .message-content p { 
            margin: 0 0 18px 0; 
        }
        
        .message-content strong, .message-content b { 
            font-weight: 700; 
            color: #1a202c; 
        }
        
        .message-content em, .message-content i { 
            font-style: italic; 
        }
        
        .message-content u { 
            text-decoration: underline; 
            text-decoration-color: var(--brand2); 
            text-underline-offset: 3px; 
            text-decoration-thickness: 2px; 
        }
        
        .message-content sub, .message-content sup { 
            font-size: 75%; 
            line-height: 0; 
            position: relative; 
            vertical-align: baseline; 
        }
        
        .message-content sup { 
            top: -0.5em; 
        }
        
        .message-content sub { 
            bottom: -0.25em; 
        }
        
        .message-content ul, .message-content ol { 
            margin: 18px 0; 
            padding-left: 28px; 
        }
        
        .message-content li { 
            margin-bottom: 12px; 
            padding-left: 8px; 
        }
        
        .message-content table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 24px 0; 
            background: #ffffff; 
            border-radius: 10px; 
            overflow: hidden; 
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07); 
        }
        
        .message-content th { 
            background: linear-gradient(135deg, var(--brand1), var(--brand2)); 
            color: white; 
            padding: 14px 16px; 
            text-align: left; 
            font-weight: 600; 
            font-size: 16px; 
        }
        
        .message-content td { 
            padding: 14px 16px; 
            border-bottom: 1px solid #e2e8f0; 
            color: var(--text); 
        }
        
        .message-content tr:last-child td { 
            border-bottom: none; 
        }
        
        .message-content tr:nth-child(even) { 
            background: #f7fafc; 
        }
        
        .message-content code { 
            background: #edf2f7; 
            color: #c53030; 
            padding: 3px 6px; 
            border-radius: 5px; 
            font-family: 'SF Mono', 'Fira Code', 'Courier New', monospace; 
            font-size: 15px; 
        }
        
        .message-content pre { 
            background: #1a202c; 
            color: #e2e8f0; 
            padding: 20px; 
            border-radius: 8px; 
            overflow-x: auto; 
            margin: 24px 0; 
            border-left: 4px solid var(--brand1); 
            white-space: pre-wrap; 
            word-break: break-word; 
        }
        
        .message-content pre code { 
            background: transparent; 
            color: inherit; 
            padding: 0; 
            font-size: 16px; 
        }
        
        .message-content .formula { 
            background: #f9fafb; 
            padding: 18px 24px; 
            border-radius: 8px; 
            border-left: 4px solid #a78bfa; 
            margin: 24px 0; 
            font-family: 'Cambria Math', 'Times New Roman', serif; 
            font-size: 1.2em; 
            color: #1f2937; 
            overflow-x: auto; 
        }
        
        .message-content hr { 
            border: none; 
            height: 2px; 
            background: linear-gradient(90deg, transparent, var(--border), transparent); 
            margin: 32px 0; 
        }
        
        .message-content blockquote { 
            border-left: 5px solid var(--brand1); 
            padding: 16px 24px; 
            margin: 24px 0; 
            color: var(--muted); 
            background: #f7fafc; 
            border-radius: 0 8px 8px 0; 
        }
        
        .message-content a { 
            color: var(--brand1); 
            text-decoration: none; 
            font-weight: 600; 
            border-bottom: 2px solid transparent; 
            transition: border-color 0.2s ease; 
        }
        
        .message-content a:hover { 
            border-bottom-color: var(--brand1); 
        }
        
        .typing-cursor {
            display: inline-block;
            width: 10px;
            height: 1.1em;
            background-color: var(--text);
            margin-left: 4px;
            border-radius: 1px;
            animation: cursor-blink 1s infinite;
            vertical-align: middle;
        }
        
        @keyframes cursor-blink {
            0%, 100% { 
                opacity: 0; 
            }
            50% { 
                opacity: 1; 
            }
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(0,0,0,0.05);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-dot.online {
            background: #10b981;
        }
        
        .status-dot.offline {
            background: #ef4444;
        }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="brand">
        <div class="brand-logo">KVS</div>
        <div>
          <h1>Callanix</h1>
          <small>AI Assistant for KVS Aliganj II Shift</small>
        </div>
      </div>
      <div class="header-stats">
        <div class="pill" id="usersCountPill">Unique Visitors: 0 / 13,000</div>
        <div class="pill" id="scanPill">Website Scan: Auto</div>
      </div>
    </header>

    <main class="app-main">
      <section class="chat-panel">
        <div class="messages" id="messages"></div>
        <div class="typing" id="typingIndicator">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
          <span id="typingText">Thinking...</span>
        </div>
      </section>

      <section>
        <div class="composer">
          <input id="userInput" type="text" placeholder="Ask about school news, or for homework help..." />
          <button id="sendBtn">Send</button>
        </div>
      </section>
    </main>
  </div>

  <div class="blocked-overlay" id="blockedOverlay">
    <div class="blocked-card">
      <h2>Access Limit Reached</h2><p>This platform has reached its capacity of 13,000 unique visitors.</p>
    </div>
  </div>

  <script>
    // ===================================================================
    // Callanix AI Assistant v8 (with Status Notifications)
    // ===================================================================

    // ========== 1. USER LIMIT / ACCESS CONTROL ==========
    function initUserAccessGate() {
      const uidKey = 'callanix_user_id_v6';
      const totalUsersKey = 'callanix_total_users_v6';
      let isNewUser = !localStorage.getItem(uidKey);
      if (isNewUser) localStorage.setItem(uidKey, 'uid-' + Date.now());
      let totalUsers = parseInt(localStorage.getItem(totalUsersKey) || '0', 10);
      if (isNewUser) {
        totalUsers++;
        localStorage.setItem(totalUsersKey, String(totalUsers));
      }
      document.getElementById('usersCountPill').textContent = `Unique Visitors: ${totalUsers} / ${CONFIG.USER_LIMIT}`;
      if (totalUsers > CONFIG.USER_LIMIT) {
        document.getElementById('blockedOverlay').style.display = 'flex';
        disableApp();
        document.getElementById('usersCountPill').classList.add('danger');
      }
    }
    function disableApp() { 
      document.getElementById('userInput').disabled = true; 
      document.getElementById('sendBtn').disabled = true; 
      document.getElementById('userInput').placeholder = 'Access limit reached.'; 
    }

    // ========== 2. AI MODELS & PROMPT (Now using CONFIG) ==========
    const MODELS = CONFIG.MODELS;
    const SYSTEM_PROMPT = CONFIG.SYSTEM_PROMPT;

    // ========== 3. KNOWLEDGE BASE & OFFLINE LOGIC ==========
    const NCERT_KEYWORDS = ['ncert', 'chapter', 'science', 'math', 'physics', 'chemistry', 'biology', 'history', 'geography', 'civics', 'economics', 'explain', 'what is', 'define', 'class 9', 'class 10', 'class 11', 'class 12'];
    const NCERT_SERVER_URL = 'http://127.0.0.1:5000/ask-ncert';
    
    function isNcertQuery(query) { 
      const lowerQuery = query.toLowerCase(); 
      const hasClass = /class\s+(\d+|ix|x|xi|xii)/.test(lowerQuery); 
      const hasSubject = ['science', 'math', 'history', 'english', 'physics', 'chemistry', 'biology'].some(s => lowerQuery.includes(s)); 
      const keywordCount = NCERT_KEYWORDS.filter(k => lowerQuery.includes(k)).length; 
      return (hasClass && hasSubject) || keywordCount >= 2; 
    }
    
    async function callNcertModel(query) { 
      showTypingIndicator('Accessing NCERT knowledge base...'); 
      try { 
        const response = await fetch(NCERT_SERVER_URL, { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify({ query: query }) 
        }); 
        if (!response.ok) { 
          const errData = await response.json().catch(() => ({ error: 'The NCERT model is not responding or returned an invalid format.' })); 
          return { ok: false, message: errData.error || 'The NCERT model is not responding.' }; 
        } 
        const data = await response.json(); 
        return { ok: true, message: data.reply, modelName: data.modelName }; 
      } catch (error) { 
        console.error('NCERT Server connection error:', error); 
        return { ok: false, message: 'Could not connect to the NCERT Knowledge Server. Please ensure the `app.py` script is running.' }; 
      } 
    }
    
    const SCHOOL_KEYWORDS = ['school', 'teacher', 'staff', 'principal', 'event', 'library', 'announcement', 'admission', 'calendar', 'holiday', 'kvs', 'aliganj', 'activity', 'contact', 'timing', 'schedule', 'exam', 'result', 'news', 'notice', 'circular'];
    
    function isSchoolRelatedQuery(query) { 
      return SCHOOL_KEYWORDS.some(keyword => query.toLowerCase().includes(keyword)); 
    }
    
    async function scanSchoolWebsites() { 
      let content = ''; 
      for (const url of ['https://aliganjshift2.kvs.ac.in/en/', 'https://kv-aliganj7.github.io/II-Shift-Library/']) { 
        try { 
          const response = await fetch(`https://r.jina.ai/${url}`); 
          if (response.ok) content += `\n\n=== Content from ${url} ===\n${await response.text()}`; 
        } catch (e) { 
          console.error(`Scan error:`, e); 
        } 
      } 
      return content || null; 
    }
    
    function runOfflineExtractorModel(scannedContent, userQuery) { 
      incrementModelCount('model_offline'); 
      const keywords = userQuery.toLowerCase().split(/\s+/).filter(w => w.length > 2 && !new Set(['the', 'a', 'is', 'are', 'what', 'who']).has(w)); 
      if (keywords.length === 0) return { ok: false }; 
      const found = new Set(); 
      scannedContent.split('\n').forEach(line => { 
        if (keywords.some(k => line.toLowerCase().includes(k)) && line.trim().length > 15) found.add(escapeHTML(line.trim())); 
      }); 
      if (found.size > 0) return { 
        ok: true, 
        message: `<h2>Offline Response</h2><p>AI models are unavailable. Here's what I found on the school websites matching your query:</p><hr><ul>${[...found].slice(0, 10).map(l => `<li>${l}</li>`).join('')}</ul>`, 
        modelName: 'Offline Extractor' 
      }; 
      return { ok: false }; 
    }

    // ========== 4. LOAD BALANCING & STREAMING API CALL LOGIC ==========
    const conversationHistory = [];
    
    function selectModel() { 
      const available = MODELS.filter(m => m.apiKey && m.apiKey.startsWith('sk-or-v1-')); 
      return available.length ? [...available].sort((a, b) => a.requestCount - b.requestCount)[0] : null; 
    }
    
    function incrementModelCount(id) { 
      const model = MODELS.find(m => m.id === id); 
      if (model) model.requestCount++; 
    }
    
    setInterval(() => { MODELS.forEach(m => m.requestCount = 0); }, 60000);

    async function callApiWithFallback(messages, primaryModel, scannedContent, userQuery, targetElement) {
      const queue = [primaryModel, ...MODELS.filter(m => m.apiKey && m.id !== primaryModel?.id)].filter(Boolean);

      for (const model of queue) {
        const animator = createTypingAnimator(targetElement);
        let isFirstChunk = true;

        try {
          const response = await fetch(model.endpoint, {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json', 
              'Authorization': `Bearer ${model.apiKey}`, 
              'HTTP-Referer': window.location.href, 
              'X-Title': 'Callanix' 
            },
            body: JSON.stringify({ 
              model: model.model, 
              messages, 
              temperature: 0.6, 
              max_tokens: 3500, 
              stream: true 
            })
          });

          if (response.ok) {
            incrementModelCount(model.id);
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullResponse = '';

            while (true) {
              const { done, value } = await reader.read();
              if (done) break;

              const chunk = decoder.decode(value, { stream: true });
              const lines = chunk.split('\n').filter(line => line.trim() !== '');

              for (const line of lines) {
                if (line.startsWith('data: ')) {
                  const dataStr = line.substring(6);
                  if (dataStr === '[DONE]') break;
                  try {
                    const data = JSON.parse(dataStr);
                    const content = data.choices[0]?.delta?.content;
                    if (content) {
                      if (isFirstChunk) {
                        hideTypingIndicator();
                        isFirstChunk = false;
                      }
                      fullResponse += content;
                      animator.update(fullResponse);
                      document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
                    }
                  } catch (e) { /* Ignore parsing errors */ }
                }
              }
            }
            animator.finish(fullResponse);
            conversationHistory.push({ role: 'assistant', content: fullResponse });
            reEnableInput();
            return;
          }
        } catch (e) {
          console.error(`API Stream Error with ${model.id}:`, e);
          animator.finish();
        }
      }

      hideTypingIndicator();
      const result = scannedContent ? runOfflineExtractorModel(scannedContent, userQuery) : { ok: false, message: 'All AI models failed to respond.' };
      targetElement.innerHTML = sanitizeHTML(result.message || 'An unexpected error occurred.');
      reEnableInput();
    }

    // ========== 5. MAIN CHAT FUNCTIONALITY ==========
    async function sendMessage() {
      const input = document.getElementById('userInput');
      const message = input.value.trim();
      if (!message) return;

      input.value = '';
      input.disabled = true;
      document.getElementById('sendBtn').disabled = true;

      displayMessage(message, 'user');
      conversationHistory.push({ role: 'user', content: message });

      if (isNcertQuery(message)) {
        const result = await callNcertModel(message);
        hideTypingIndicator();
        if (result.ok) {
          conversationHistory.push({ role: 'assistant', content: result.message });
          displayMessage(result.message, 'ai', result.modelName);
        } else {
          displayMessage(`<p><strong>Error:</strong> ${result.message}</p>`, 'ai', 'System');
        }
        reEnableInput();
      } else {
        let scannedContent = null;
        if (isSchoolRelatedQuery(message)) {
          showTypingIndicator('Scanning school websites...');
          scannedContent = await scanSchoolWebsites();
        }

        showTypingIndicator('Thinking...');
        const apiMessages = [{ role: 'system', content: SYSTEM_PROMPT }];
        if (scannedContent) apiMessages.push({ role: 'system', content: `=== SCANNED CONTENT ===\n${scannedContent}\n\nAnswer using this content.` });
        apiMessages.push(...conversationHistory);

        const model = selectModel();
        const modelName = model ? model.model.split('/')[1] : 'Fallback';
        const aiContentElement = displayMessage('', 'ai', modelName);

        callApiWithFallback(apiMessages, model, scannedContent, message, aiContentElement);
      }
    }

    // ========== 6. UI & UTILITY FUNCTIONS ==========
    function reEnableInput() { 
      const input = document.getElementById('userInput'); 
      input.disabled = false; 
      document.getElementById('sendBtn').disabled = false; 
      input.focus(); 
    }
    
    function createTypingAnimator(targetElement) { 
      targetElement.innerHTML = ''; 
      const contentSpan = document.createElement('span'); 
      const cursorSpan = document.createElement('span'); 
      cursorSpan.className = 'typing-cursor'; 
      targetElement.appendChild(contentSpan); 
      targetElement.appendChild(cursorSpan); 
      return { 
        update(newHtmlContent) { contentSpan.innerHTML = sanitizeHTML(newHtmlContent); }, 
        finish(finalHtmlContent) { 
          if (finalHtmlContent) { 
            targetElement.innerHTML = sanitizeHTML(finalHtmlContent); 
          } else { 
            cursorSpan.remove(); 
          } 
        } 
      }; 
    }
    
    function showTypingIndicator(text = 'Thinking...') { 
      document.getElementById('typingText').textContent = text; 
      document.getElementById('typingIndicator').style.display = 'flex'; 
    }
    
    function hideTypingIndicator() { 
      document.getElementById('typingIndicator').style.display = 'none'; 
    }
    
    function displayMessage(content, role, modelName = 'You') { 
      const messagesEl = document.getElementById('messages'); 
      const row = document.createElement('div'); 
      row.className = `msg ${role}`; 
      const bubble = document.createElement('div'); 
      bubble.className = 'bubble'; 
      const meta = document.createElement('div'); 
      meta.className = 'meta'; 
      meta.innerHTML = role === 'user' ? 'You' : `Callanix <span class="model-name">(via ${modelName})</span>`; 
      const contentDiv = document.createElement('div'); 
      contentDiv.className = 'message-content'; 
      if (role === 'user') { 
        contentDiv.innerHTML = escapeHTML(content); 
      } else if (content) { 
        contentDiv.innerHTML = sanitizeHTML(content); 
      } 
      bubble.append(meta, contentDiv); 
      row.appendChild(bubble); 
      messagesEl.appendChild(row); 
      messagesEl.scrollTop = messagesEl.scrollHeight; 
      if (role === 'ai') { 
        return contentDiv; 
      } 
    }
    
    function escapeHTML(s) { 
      const el = document.createElement('div'); 
      el.textContent = s; 
      return el.innerHTML; 
    }
    
    function sanitizeHTML(dirty) { 
      try { 
        const parser = new DOMParser(); 
        const doc = parser.parseFromString(dirty, 'text/html'); 
        const allowedTags = new Set(['h1','h2','h3','h4','h5','h6','p','strong','b','em','i','u','sub','sup','ul','ol','li','table','thead','tbody','tr','th','td','code','pre','div','hr','blockquote','span','br','a']); 
        doc.body.querySelectorAll('*').forEach(node => { 
          if (!allowedTags.has(node.tagName.toLowerCase())) { 
            node.remove(); 
            return; 
          } 
          Array.from(node.attributes).forEach(attr => { 
            const attrName = attr.name.toLowerCase(); 
            if (attrName.startsWith('on') || attrName === 'style' || (attrName === 'class' && !node.classList.contains('formula'))) { 
              node.removeAttribute(attr.name); 
            } 
            if (node.tagName.toLowerCase() === 'a' && attrName === 'href') { 
              if ((node.getAttribute('href') || '').startsWith('javascript:')) node.removeAttribute('href'); 
              else { 
                node.setAttribute('target', '_blank'); 
                node.setAttribute('rel', 'noopener noreferrer'); 
              } 
            } 
          }); 
        }); 
        return doc.body.innerHTML; 
      } catch (e) { 
        return escapeHTML(dirty); 
      } 
    }

    // ========== 7. EVENT LISTENERS & INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', () => {
      initUserAccessGate();
      if (!document.getElementById('userInput').disabled) {
        displayMessage('<h2>Welcome to Callanix</h2><p>Your AI assistant is ready! Ask me for homework help (e.g., "Explain Newton\'s laws from class 9 science") or about school news. My answers are designed to be clear and easy to read.</p>', 'ai', 'System');
      }
      document.getElementById('sendBtn').addEventListener('click', sendMessage);
      document.getElementById('userInput').addEventListener('keydown', (e) => { 
        if (e.key === 'Enter' && !e.shiftKey) { 
          e.preventDefault(); 
          sendMessage(); 
        } 
      });
    });
  </script>
</body>
</html>